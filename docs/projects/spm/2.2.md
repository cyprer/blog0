# 一.本章诉求
在公司中实际做项目，会先有产品拉一个评审会，对本地需求的 PRD 进行评审。这个过程会有产品、研发（前后端）、测试，一起参与评审。一般在 30分钟 ~ 2小时的会议。评审完成后，研发会对需求进行分工，较大型的项目，会有几个研发同时介入。之后每个研发进行设计阶段，设计会包括新项目的工程框架、技术栈选择、需求的模型设计（DDD）、功能的流程（MVC）实现、要实现和改动点说明等。

本节我们就按照这样的一个过程进行需求的研发设计，主要包括；用户用例图、四色建模（领域拆分）、UML流程图、改动点。有这些东西就可以指导研发开发了。

本项目会搭建 MVC、DDD 双套工程，四色建模主要给 DDD 工程使用。

# 二.用户用例图
研发可以根据产品PRD提供的业务UI和流程，分析出用户会有的行为，根据行为画出用户用例图；  
![](https://raw.githubusercontent.com/cyprer/photo/main/obsidian/20250327094935813.png)


- 用例图（英语：use case diagram）是用户与系统交互的最简表示形式，展现了用户和与他相关的用例之间的关系。通过用例图，人们可以获知系统不同种类的用户和用例。用例图也经常和其他图表配合使用。

- 用例图，也可以等同于是用户故事（英语：User story）（软件开发和项目管理中的常用术语），主旨是以日常语言或商务用语撰写句子，是一段简单的功能表述。以客户或使用者的观点撰写下有价值的功能、引导、框架来与使用者进行互动，进而推动工作进程。可以被认为是一种规格文件，但更精确而言，它代表客户的需求与方向。以该用户故事来反应对象在组织内的其工作职责、范围、需要进行的任务等。用户故事在敏捷开发方法中用来定义系统需要提供的功能和实现需求管理。

- 尽管用例本身会涉及大量细节和各种可能性，用例图却能提纲挈领地让人了解系统概况。它为“系统做什么”提供了简化了的图形表示，因此被誉为“搭建系统的蓝图”。
# 三.四色建模
## 1.寻找领域事件

- 在我们这个小项目下，可以寻找的领域，包括；商品下单完成、支付订单创建完成、订单状态变更完成、登录凭证创建和校验完成、保存登录状态完成。

- 所有这些领域事件都是一种完成态（最终的结果态），比如说，要去吃饭，是决策的命令。是你的想法要付诸行动。之后你说吃完饭了，就是最终的领域事件的结果态。从付诸行动到怎么去吃饭，去哪吃饭，要跟谁吃饭，是业务流程。吃饭前要给谁打电话，询问是否开业中，是读模型。
## 2.识别领域角色和对象
在确定了领域事件以后，接下来要做的就是通过决策命令串联领域事件，并填充上所需要的领域对象。这块的操作，新手可以分开处理，如先给领域事件添加决策命令、执行用户和领域对象，最后在串联流程。就像 事件风暴定义 中的示意一样。
![](https://raw.githubusercontent.com/cyprer/photo/main/obsidian/20250327095251078.png)

- 首先，我们给领域事件，提供对应的决策命令。也就是常说的结果导向，先有结果在寻找结果是谁来驱动的。在这个过程中，我们找到了；扫码登录、点击下单、支付回调、超时和支付状态检测任务。

- 之后，为决策命令和领域事件连线，对于复杂的业务，会有一个业务流程标签。比如我们说的你要去吃饭，那么你自己去吃饭和约女友或者组织公司一群人团建吃饭，那么它的业务复杂程度是不一样的。

- 最后，我们在给决策命令添加领域对象。这个领域对象就是一种承载体，比如你要去吃饭，你是打车把你带过去，还是11路腿着过去。这些就是你的领域对象，领域对象用于承载决策命令完成的领域事件。
# 四.流程设计
系统建模后，接下来研发就要做细节的流程设计了。这个过程会使用到 UML 画执行流程图。最终的代码也是这个执行过程，不过不一定 if...else 编码，而是采用一些设计模式进行解耦。
## 1.登录校验
微信扫码登录的流程主要包括；用户、浏览器、后端服务、公众号，这四个部分。

- 首先，由用户发起登录操作。让WEB页面从服务端获取登录凭证。

- 之后，前端页面拿到登录凭证后，可以使用 Ticket 从公众号服务平台换取二维码。

- 最后，用户扫码登录。扫码后，服务端会接收到来自公众号的回调消息，服务端再把回调消息中的 openid【用户唯一标识】和 ticket 进行绑定。这个时候你也可以创建出 jwt token 反馈给前端，作为登录成功的存储信息，后续校验 jwt token 就可以了。

- 微信公众号测试平台：[](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login) 不需要申请公众号即可完成测试，类似沙箱环境

- 获取 Access Token 文档:[](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html)

- 生成带参数的二维码：[](https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html)- 最终就是用户扫描的二维码

- 内网穿透工具，[natapp.cn](natapp.cn) - 因为需要让公众号调用到本地的服务，所需要把你的服务映射到公网上使用。注意；要选择付费的12元，否则不能对接。
## 2.商品交易

- 首先，用户在系统中创建订单（流水单），创建过程中需要判断是否存在未支付订单，存在则可以直接返回。另外还有一种可能，创建的订单存在，但没有支付单，也就是【掉单】。这是因为本身的业务系统和外部的支付创建（支付宝）不是一个事务，不能一起成功或失败，所以要做一些流程的校验。比如我们创建订单成功，但创建支付单失败。这个之后用户继续创建订单，就会优先使用这笔订单创建支付单。如果流程中没有存在的掉单，则直接创建支付单即可。

- 之后，创建完支付宝订单，会由页面跳转到网络收银台，引导用户完成支付操作。

- 最后，就是接收支付回调消息，更新本地的订单状态，以及推动后续流程。比如；发放商品、驱动物流、虚拟支付等。当然在实际的商城中，还会有逆向流程，比如商品有问题，或者用户主动发起退单。这个时候就要走逆向流程，退单、审核、退款流程。你可以尝试完成。

支付宝|开放平台 地址：[](https://open.alipay.com/develop/manage)
# MVCC（多版本并发控制）核心原理
## 一、MVCC 定义
MVCC（Multi-Version Concurrency Control）即多版本并发控制，是 InnoDB 为解决读写冲突、提升数据库并发性能设计的核心机制，通过为数据维护多个版本，让读操作无需加锁即可读取历史版本，实现“读不加锁、读写不阻塞”，同时保证事务隔离性。

## 二、MVCC 的实现基础
MVCC 的实现依赖三大核心组件：
1. 行记录的 4 个隐式字段
2. Undo Log（回滚日志）
3. Read View（读视图）

---

## 三、行记录的隐式字段
InnoDB 中每行记录除自定义字段外，还包含数据库隐式定义的字段，核心字段如下：

| 字段名         | 字节数 | 作用说明                                                                 |
|----------------|--------|--------------------------------------------------------------------------|
| DB_ROW_ID      | 6byte  | 隐含自增 ID（隐藏主键），若数据表无主键，InnoDB 会以此生成聚簇索引        |
| DB_TRX_ID      | 6byte  | 最近修改（插入/更新）事务 ID：记录创建/最后一次修改该记录的事务 ID         |
| DB_ROLL_PTR    | 7byte  | 回滚指针：指向该记录的上一个版本（存储于 rollback segment 中）            |
| DELETED_BIT    | 1byte  | 删除标记：记录更新/删除时仅修改该标记（逻辑删除），非物理删除             |

> 说明：DELETE 操作仅修改 DELETED_BIT 为 true，不会立即物理删除记录；InnoDB 有专门的 purge 线程清理该标记为 true 的记录，且 purge 线程会维护独立 Read View，确保不影响 MVCC 正常工作。

---

## 四、Undo Log（回滚日志）
### 1. Undo Log 定义
Undo Log 是 InnoDB 为事务回滚、MVCC 提供的历史数据版本链，仅在数据修改（增/删/改）时生成，查询操作（SELECT）无需记录。

### 2. Undo Log 分类
| 类型            | 作用说明                                                                 |
|-----------------|--------------------------------------------------------------------------|
| Insert Undo Log | 插入记录时记录主键值，回滚时删除对应主键记录即可                         |
| Update Undo Log | 修改记录时记录数据旧值，回滚时将记录恢复为修改前状态（对 MVCC 最关键）|
| Delete Undo Log | 删除记录时记录完整数据，回滚时重新插入该记录（实际为修改 DELETED_BIT）|

### 3. Undo Log 生成流程（版本链形成）
以 `person` 表一条记录的修改为例，说明版本链生成过程：
1. **初始状态**：插入一条记录（name=Jerry，age=24，DB_ROW_ID=1），此时 DB_TRX_ID、DB_ROLL_PTR 均为 NULL。
2. **事务 1 修改（name→Tom）**：
   - 对该行加排他锁（X 锁）；
   - 将当前记录拷贝到 Undo Log 作为旧版本；
   - 修改记录 name 为 Tom，更新 DB_TRX_ID 为事务 1 的 ID，DB_ROLL_PTR 指向 Undo Log 中的旧版本；
   - 事务提交后释放锁。
3. **事务 2 修改（age→30）**：
   - 对该行加排他锁；
   - 将当前记录（Tom/24）拷贝到 Undo Log，作为版本链的表头（最新旧版本）；
   - 修改记录 age 为 30，更新 DB_TRX_ID 为事务 2 的 ID，DB_ROLL_PTR 指向刚拷贝的旧版本；
   - 事务提交后释放锁。

> 最终效果：同一记录的多次修改会形成 Undo Log 版本链，链首为最新旧版本，链尾为最早旧版本（部分过期版本会被 purge 线程清理）。

---

## 五、Read View（读视图）
### 1. Read View 定义
Read View 是事务执行**快照读**时生成的“可见性判断规则”，记录生成时刻系统中活跃事务的 ID，用于判断当前事务能看到哪个版本的数据（最新版本/Undo Log 中的历史版本）。

### 2. Read View 核心属性（简化版）
| 属性名         | 含义说明                                                                 |
|----------------|--------------------------------------------------------------------------|
| trx_list       | 未提交事务 ID 列表：维护 Read View 生成时刻系统中活跃（未提交）的事务 ID   |
| up_limit_id    | 活跃事务最小 ID：trx_list 中事务 ID 的最小值                             |
| low_limit_id   | 下一个事务 ID：Read View 生成时刻系统尚未分配的事务 ID（已分配最大 ID + 1）|

### 3. 可见性判断算法
将待读取记录的 DB_TRX_ID（修改该记录的事务 ID）与 Read View 属性逐一对比，判断该版本是否对当前事务可见：
1. **第一步**：若 `DB_TRX_ID < up_limit_id` → 该版本由“已提交事务”修改，当前事务可见；
2. **第二步**：若 `DB_TRX_ID >= low_limit_id` → 该版本在 Read View 生成后才修改，当前事务不可见；
3. **第三步**：若 `trx_list.contains(DB_TRX_ID)` → 该版本由“活跃未提交事务”修改，当前事务不可见；反之则可见。

> 若当前版本不可见，通过 DB_ROLL_PTR 回溯 Undo Log 版本链，重复上述判断，直到找到可见版本。

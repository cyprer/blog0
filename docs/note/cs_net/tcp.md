# TCP协议

## 拥塞控制算法
> 大多数基于主机的算法遵循相同的通用方法，差异出现在三个关键的选择点。
每个源都独立地循环执行以下逻辑：尝试以速率 R 发送一段时间。然后，询问：在这段时间内我是否遇到了拥塞？如果是，则减少 R。如果没有，则增加 R。
一个缺失的问题是：我们最初以什么速率发送？我们需要某种方法来选择初始速率 R。
三个关键的选择点是：如何选择初始速率？如何检测拥塞？每次应该增加和减少多少？

### 检测拥塞
  发送方如何检测网络是否拥塞？有两种常见的方法。

发送方可以检查数据包是否丢失。这是 TCP 常用的方法。这种方法很好，因为信号明确。每个数据包要么被标记为丢失（超时或重复确认），要么没有丢失。此外，TCP 已经检测到丢失的数据包并重新发送，因此我们无需从头开始重新实现。

这种方法可能很糟糕，因为有时数据包丢失是由于损坏（校验和错误）而不是拥塞造成的。事实上，当链路没有拥塞时，TCP 会感到困惑并表现不佳，但经常会损坏数据包。此外，TCP 可能会因数据包的重新排序而感到困惑。迟到的数据包可能会被误认为丢失。

这种方法的另一个主要缺点是，我们检测拥塞的时间太晚。当数据包被丢弃时，路由器队列已经满了，导致数据包被延迟。

第二种方法是发送方可以通过检查数据包延迟来检测拥塞，而不是检查数据包丢失。发送方可以测量从发送数据包到收到该数据包确认的时间。如果发送方注意到延迟正在增加，则可能是拥塞的征兆。

### 发现初始速率(慢启动)
  我们希望这个发现过程是安全的，所以我们应该从慢速开始。我们不想让数据包立即淹没网络。

同时，为了提高效率，我们希望发现过程能够快速找到可用带宽。为了实现这一点，我们会在每次后续尝试中快速提高速率。为了支持慢启动但快速上升，我们每次都会将带宽增加一个乘性因子（而不是加性因子）。这种解决方案称为慢启动.

### 应对拥塞
  当发送方检测到拥塞时，它会将速率减半。这被称为拥塞避免。

## 拥塞控制实现
- cwnd：窗口大小,**滑动窗口的 “可发送新数据” 不依赖左边界是否右移，只依赖 “右边界是否超过了已发送数据的最大序号”**
- ssthresh：慢启动阈值,即slowstartthreshold的缩写
1. 慢启动：
cwnd指数型增加直到收到三次重复确认序列号,cwnd会减少一半,此时ssthresh会设置为当前的cwnd,也就是说cwnd不是达到ssthresh就会减半,而是收到三次重复确认序列号才会减半。存在一个问题,就是孤立的数据包丢失导致窗口卡住，从而导致发送方停滞不前，什么也没发送。最终，当该数据包被重新发送并得到确认时，窗口向前跳跃，导致发送方混乱地一次性发送一堆新数据包。发送方现在必须等待另一个往返，直到这些新数据包得到确认，然后才能恢复正常业务。
2. 拥塞避免:解决窗口卡住问题
当速率接近网络承载上限时，缓慢提升发送速率，避免突发拥塞（“慢增长” 替代 “快增长”）。

触发场景：  
仅当cwnd ≥ ssthresh时进入（慢启动的自然过渡）。
增长规则：  
每经过一个 RTT，cwnd按线性增长（每次仅增加 1 个 MSS），避免速率飙升。
例：cwnd=16→ 发送 16 个包→收到所有 ACK→cwnd=17；
再经过一个 RTT→cwnd=18…… 以此类推。
拥塞处理：
若检测到拥塞（3 次重复 ACK 或超时），则：
立即将ssthresh调整为当前cwnd的一半（ssthresh = cwnd/2，记录 “安全速率”）；
若为 3 次重复 ACK→ 进入快速恢复阶段（解决孤立丢包问题）；
若为超时→ 重置cwnd=1，重新进入慢启动（因超时代表拥塞更严重）


- 快速恢复:解决独立数据包丢失问题
  当我们收到 3 个重复确认时，会触发快速恢复模式。我们不再像之前那样直接将 CWND 减半，而是将 CWND 设置为 CWND/2 + 3,在快速恢复模式下，每个额外的重复确认都会导致 CWND 增加 1，从而允许窗口人为延长。最终，当我们收到一个新的、非重复的确认消息时，我们会退出快速恢复模式，并将 CWND 设置为 SSTHRESH。需要注意的是，虽然我们人为地延长了窗口，但 SSTHRESH 始终会帮助我们记住最终想要发送的初始减半速率。


  
- 超时重传:
  触发场景:
  发送方在 RTO（重传超时时间，通常为 RTT 的 2~3 倍）内未收到任何 ACK，判定为 “严重拥塞”（可能路由器队列已满，大量丢包）。
  执行:
  1. 立即重传丢失的数据包；
  2. 调整ssthresh = max(cwnd/2, 2*MSS)（确保阈值不低于最小有效窗口）；
  3. 重置cwnd = 1（彻底降低发送速率，避免加剧拥塞）；
  4. 重新进入慢启动阶段，从极小窗口开始指数增长，直到再次达到ssthresh后进入拥塞避免。
